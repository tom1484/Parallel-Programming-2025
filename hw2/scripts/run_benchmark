#!/usr/bin/env bash
source scripts/env.sh

# Build the project
echo "Building project..."
cmake --build build/Release
echo ""

N=1
PE=1
NP=2
THREADS=2

echo "Running benchmark on all $N testcases..."
echo "================================================"

# Initialize total time
total_time=0

# Handle interruptions to ensure logs are recorded
trap 'echo "Script interrupted. Check logs for details."; exit 1' INT TERM

# Iterate over all N testcases
for i in $(seq 1 $N); do
    testcase_id=$(printf "%02d" "$i")
    
    if [[ ! -f assets/testcases/"$testcase_id".jpg ]]; then
        echo "Testcase ${testcase_id}: File not found - skipping"
        continue
    fi
    
    # Run the solver and measure time
    start_time=$(date +%s%N)
    mpirun --map-by socket:PE=$PE \
        -np $NP -x OMP_NUM_THREADS=$THREADS \
        -x OMP_PROC_BIND=close \
        ./build/Release/hw2 \
        assets/testcases/"$testcase_id".jpg \
        results/"$testcase_id".jpg \
        results/"$testcase_id".txt \
        &> results/"$testcase_id".log \
        || echo "Command interrupted or failed" >> results/"$testcase_id".log
    end_time=$(date +%s%N)
    elapsed_time_ns=$((end_time - start_time))
    elapsed_time_seconds=$(echo "scale=6; $elapsed_time_ns / 1000000000" | bc -l)
    
    # Add to total time (keep in nanoseconds for accuracy)
    total_time=$((total_time + elapsed_time_ns))
    
    # Validate the result
    validation_result=$(python scripts/validate.py \
        results/"$testcase_id".txt \
        assets/goldens/"$testcase_id".txt \
        results/"$testcase_id".jpg \
        assets/goldens/"$testcase_id".jpg > results/"$testcase_id".val.log)
    if ! grep -q "Pass" results/"$testcase_id".val.log; then
        status="FAILED"
    else
        status="PASSED"
    fi
    # if [[ $? -eq 0 ]]; then
    # else
    # fi
    
    # Output in the requested format
    printf "Testcase %s: %.6f seconds - %s\n" "$testcase_id" "$elapsed_time_seconds" "$status"
done

echo "================================================"
echo "Benchmark completed!"
total_time_seconds=$(echo "scale=6; $total_time / 1000000000" | bc -l)
average_time_seconds=$(echo "scale=6; $total_time / $N / 1000000000" | bc -l)
printf "Total time: %.6f seconds\n" "$total_time_seconds"
printf "Average time per testcase: %.6f seconds\n" "$average_time_seconds"